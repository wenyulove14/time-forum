<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>时之论坛</title>

    <!-- PWA & Mobile App Meta Tags (START) -->
    <!-- 设置浏览器顶部状态栏颜色 (安卓Chrome) -->
    <meta name="theme-color" content="#FFFFFF">
    <!-- 链接 Manifest 文件 -->
    <link rel="manifest" href="manifest.json">
    <!-- iOS Safari 支持 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="时之论坛">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <!-- PWA & Mobile App Meta Tags (END) -->

    <style>
        /* CSS样式部分保持不变 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #EAE7DE;
            width: 100vw;
            height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
            height: 100vh;
            background: #EAE7DE;
            display: flex;
            flex-direction: column;
        }
        
        .main-container {
            display: none;
        }
        
        .main-container.active {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .header {
            background: #EAE7DE;
            padding: 80px 20px 40px;
            text-align: center;
        }
        
        .title {
            font-size: 42px;
            font-family: 'SimSun', serif;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }
        
        .subtitle {
            font-size: 20px;
            font-family: 'SimSun', serif;
            font-weight: bold;
            color: #666;
        }
        
        .welcome-section {
            background: white;
            margin: 20px;
            border-radius: 3px;
            padding: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        
        .welcome-left {
            text-align: left;
        }
        
        .welcome-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .sub-text {
            font-size: 13px;
            color: #999;
        }
        
        .login-btn {
            background: #88A936;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 0;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            font-family: 'KaiTi', 'STKaiti', serif;
            flex-shrink: 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .main-content {
            flex: 1;
            padding: 0 20px 100px;
            overflow-y: auto;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .main-card {
            background: white;
            border-radius: 3px;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        
        .card-top {
            height: 75%;
            display: flex;
            position: relative;
        }
        
        .section-item {
            flex: 1;
            text-align: center;
            cursor: pointer;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .section-divider {
            position: absolute;
            left: 50%;
            top: 20px;
            bottom: 20px;
            width: 1px;
            background: #e0e0e0;
            transform: translateX(-50%);
        }
        
        .section-title {
            font-size: 16px;
            color: #333;
            margin-bottom: 2px;
            font-weight: 500;
            line-height: 1.2;
        }
        
        .section-subtitle {
            font-size: 10px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            line-height: 1.2;
            margin-bottom: 8px;
        }
        
        .card-bottom {
            height: 25%;
            border-top: 1px solid #e0e0e0;
            margin: 0 20px;
            cursor: pointer;
        }
        
        .messages-content {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            height: 100%;
            justify-content: space-between;
        }
        
        .message-icon {
            font-size: 20px;
        }
        
        .message-text {
            display: flex;
            align-items: center;
            width: 100%;
            justify-content: space-between;
        }
        
        .message-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .message-title {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }
        
        .message-sub {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            display: flex;
            border-top: 1px solid #e0e0e0;
            height: 60px;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
        }
        
        .nav-item.active {
            color: #88A936;
        }
        
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #88A936;
        }
        
        .nav-text {
            font-size: 16px;
            color: #333;
        }
        
        .nav-item.active .nav-text {
            color: #88A936;
            font-weight: 500;
        }
        
        .settings-form, .profile-form {
            background: white;
            border-radius: 3px;
            padding: 25px 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        
        .profile-title {
            font-size: 18px;
            color: #333;
            margin-bottom: 20px;
            font-weight: 500;
            text-align: center;
        }
        
        .certified-badge {
            display: inline-block;
            background: #88A936;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 8px;
        }

        /* 新增：楼主标识样式 */
        .op-tag {
            display: inline-block;
            background: #88A936;
            color: white;
            padding: 1px 6px;
            border-radius: 8px;
            font-size: 9px;
            margin-left: 6px;
            font-weight: normal;
            vertical-align: middle;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 16px;
            background: #f9f9f9;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #88A936;
            background: white;
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .save-btn {
            width: 100%;
            background: #2A2A2A;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 3px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 500;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        /* 新增：清除按钮样式 */
        .clear-btn {
            background: #CC726A;
        }
        
        .prompt-note {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            font-style: italic;
        }
        
        /* 新增样式 */
        .input-with-btn {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-with-btn .form-input {
            flex: 1;
        }

        .fetch-btn {
            padding: 12px 15px;
            background: #88A936;
            color: white;
            border: none;
            border-radius: 0;
            cursor: pointer;
            font-family: 'KaiTi', 'STKaiti', serif;
            font-size: 14px;
            font-weight: 500;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .fetch-btn:disabled {
            background: #aaa;
            cursor: not-allowed;
        }
        /* 新增样式结束 */

        /* 论坛列表页面样式 */
        .forum-container {
            display: none;
            width: 100%;
            min-height: 100vh;
            background: #EAE7DE;
            padding-bottom: 80px;
        }
        
        .forum-container.active {
            display: block;
        }
        
        .forum-header {
            background: white;
            padding: 18px 20px; /* 修改：增加了上下内边距，使顶栏变宽 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .forum-logo-section {
            display: flex;
            flex-direction: column;
        }
        
        .forum-logo-title {
            font-size: 24px; /* 修改：增大了字号 */
            font-family: 'SimSun', serif;
            font-weight: bold;
            color: #333;
            line-height: 1.2;
        }
        
        .forum-logo-subtitle {
            font-size: 12px; /* 修改：增大了字号 */
            font-family: 'SimSun', serif;
            font-weight: bold;
            color: #666;
            margin-top: 1px;
        }
        
        .forum-header-buttons {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .forum-header-btn {
            padding: 9px 15px; /* 修改：增加了内边距，使按钮变大 */
            border: none;
            font-size: 14px; /* 修改：增大了按钮字号 */
            cursor: pointer;
            font-weight: 500;
            border-radius: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            font-family: 'KaiTi', 'STKaiti', serif;
        }
        
        .forum-refresh-btn, .forum-post-btn {
            background: #88A936;
            color: white;
        }
        
        .forum-back-btn {
            background: #2A2A2A;
            color: white;
        }
        
        .forum-content {
            padding: 15px;
            padding-bottom: 80px;
        }
        
        .forum-post-card {
            background: white;
            border-radius: 3px;
            padding: 8px 15px;
            margin-bottom: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: transform 0.2s ease;
            min-height: 55px;
        }
        
        .forum-post-card:hover {
            transform: translateY(-1px);
        }
        
        .forum-post-title {
            font-size: 15px;
            color: #333;
            font-weight: 500;
            line-height: 1.4;
            margin-bottom: 5px;
        }
        
        .forum-post-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #666;
        }
        
        .forum-post-meta-left {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .forum-post-time {
            color: #999;
        }
        
        .forum-pagination {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            padding: 12px 20px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .forum-pagination-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border-radius: 3px;
        }
        
        .forum-pagination-btn:hover {
            background: #f5f5f5;
        }
        
        .forum-pagination-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .forum-page-info {
            font-size: 12px;
            color: #666;
            margin: 0 10px;
        }
        
        .forum-loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        /* 帖子详情页面样式 */
        .detail-container {
            display: none;
            width: 100%;
            min-height: 100vh;
            background: #EAE7DE;
            padding-bottom: 80px;
        }
        
        .detail-container.active {
            display: block;
        }
        
        .detail-header {
            background: white;
            padding: 18px 20px; /* 修改：增加了上下内边距，使顶栏变宽 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .detail-back-btn {
            padding: 9px 15px; /* 修改：增加了内边距，使按钮变大 */
            border: none;
            font-size: 14px; /* 修改：增大了按钮字号 */
            cursor: pointer;
            font-weight: 500;
            border-radius: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            font-family: 'KaiTi', 'STKaiti', serif;
            background: #2A2A2A;
            color: white;
        }
        
        .detail-title {
            font-size: 20px; /* 修改：增大了字号 */
            font-weight: 500;
            color: #333;
            flex: 1;
            text-align: center;
            margin: 0 20px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .detail-content {
            padding: 15px;
        }
        
        .main-post {
            background: #EAE7DE;
            padding: 15px 0;
            margin-bottom: 15px;
        }
        
        .post-author {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }
        
        .post-content {
            font-size: 14px;
            color: #333;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .post-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #999;
            border-top: 1px solid #ddd;
            padding-top: 8px;
        }
        
        .reply-card {
            background: #EAE7DE;
            padding: 12px 0;
            margin-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }
        
        /* 新增：用户回复高亮样式 */
        .user-reply {
            background: #F5F9EE; /* 淡绿色背景 */
            border-top: 1px solid #DCE5C5;
            border-bottom: 1px solid #DCE5C5;
            margin: 4px -15px; /* 负外边距使其横向占满 */
            padding: 12px 15px;
        }

        .reply-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .reply-author-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .reply-author {
            font-size: 13px;
            font-weight: 500;
            color: #333;
        }
        
        .reply-floor {
            font-size: 11px;
            color: #999;
        }
        
        .reply-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .reply-time {
            font-size: 10px;
            color: #999;
        }
        
        .reply-btn {
            background: #88A936;
            color: white;
            border: none;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .quote-block {
            background: #f8f9fa;
            border-left: 3px solid #88A936;
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 0 3px 3px 0;
        }
        
        .quote-author {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .quote-content {
            font-size: 12px;
            color: #555;
            line-height: 1.4;
        }
        
        .reply-content {
            font-size: 13px;
            color: #333;
            line-height: 1.5;
            margin-bottom: 6px;
        }
        
        .load-more-btn {
            width: 100%;
            background: #88A936;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 3px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            font-family: 'KaiTi', 'STKaiti', serif;
        }
        
        .reply-input-section {
            background: white;
            border-radius: 3px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        
        .reply-input-title {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 10px;
        }
        
        .reply-textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
            resize: vertical;
            background: #f9f9f9;
        }
        
        .reply-textarea:focus {
            outline: none;
            border-color: #88A936;
            background: white;
        }
        
        .reply-submit-btn {
            background: #88A936;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            font-family: 'KaiTi', 'STKaiti', serif;
        }
        
        /* 加载动画 */
        .loading-animation {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            gap: 10px;
        }
        
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-top: 2px solid #88A936;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #666;
            font-size: 14px;
        }
        
        .ai-generating {
            background: #f0f8f0;
            border: 1px solid #c8e6c9;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .ai-icon {
            width: 16px;
            height: 16px;
            border: 2px solid #88A936;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        .ai-text {
            color: #4a7c59;
            font-size: 13px;
        }
        
        /* 模态框样式 */
        .modal, .forum-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content, .forum-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px 20px;
            border-radius: 3px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .modal-title, .forum-modal-title {
            text-align: center;
            font-size: 18px;
            color: #333;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .modal-close, .forum-modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
        }
        
        .login-form-btn, .forum-submit-btn {
            width: 100%;
            background: #88A936;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 3px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            font-family: 'KaiTi', 'STKaiti', serif;
        }
        
        .login-form-btn {
            background: #2A2A2A;
        }
        
        .toast {
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .toast.show {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 主页面 -->
        <div class="main-container active" id="mainContainer">
            <div class="header">
                <div class="title">时之论坛</div>
                <div class="subtitle">The Forum of the Time</div>
            </div>

            <div class="welcome-section">
                <div class="welcome-left">
                    <div class="welcome-text" id="welcomeText">欢迎登录</div>
                    <div class="sub-text" id="subText">登录后解锁阅览权限</div>
                </div>
                <button class="login-btn" id="loginBtn">立即登录</button>
            </div>

            <div class="main-content">
                <!-- 发现页面 -->
                <div class="page active" id="discoverPage">
                    <div class="main-card">
                        <div class="card-top">
                            <div class="section-item" onclick="navigateToChat()">
                                <div class="section-title">交流</div>
                                <div class="section-subtitle">COMMUNICATE</div>
                                <div class="section-title">灌水</div>
                                <div class="section-subtitle">SPAM</div>
                                <div class="section-title">聊天</div>
                                <div class="section-subtitle">CHAT</div>
                            </div>
                            <div class="section-divider"></div>
                            <div class="section-item" onclick="navigateToAnonymous()">
                                <div class="section-title">匿名板块</div>
                                <div class="section-subtitle">ANONYMOUS</div>
                            </div>
                        </div>

                        <div class="card-bottom" onclick="navigateToMessages()">
                            <div class="messages-content">
                                <div class="message-left">
                                    <div class="message-icon">✉</div>
                                    <div class="message-title">我的消息</div>
                                </div>
                                <div class="message-sub">MY MESSAGES</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 设置页面 -->
                <div class="page" id="settingsPage">
                    <div class="settings-form">
                        <div class="form-group">
                            <label class="form-label">Base URL</label>
                            <input type="url" class="form-input" id="baseUrl" placeholder="例如: https://api.openai.com">
                            <div class="prompt-note" id="apiUrlPreview">API 调用地址预览: </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">API Key</label>
                            <input type="password" class="form-input" id="apiKey" placeholder="请输入您的API密钥">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Model Name</label>
                            <div class="input-with-btn">
                                <input type="text" class="form-input" id="modelName" list="modelList" placeholder="输入或点击右侧按钮拉取">
                                <button class="fetch-btn" id="fetchModelsBtn" onclick="fetchModels()">拉取</button>
                            </div>
                            <datalist id="modelList"></datalist>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Temperature (温度)</label>
                            <input type="number" class="form-input" id="temperature" placeholder="请输入温度值 (0.0-1.0)" min="0" max="1" step="0.1">
                            <div class="prompt-note">控制AI回复的随机性，值越低回复越一致，值越高回复越随机</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">自设</label>
                            <textarea class="form-input form-textarea" id="prompt" placeholder="请输入您希望AI了解的关于您的设定和身份..."></textarea>
                            <div class="prompt-note">这里填写您希望AI了解的关于您的个人设定、身份背景等信息</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">补充设定</label>
                            <textarea class="form-input form-textarea" id="supplementarySettings" placeholder="回复的语气、对刀剑男士的私设、世界观等..."></textarea>
                            <div class="prompt-note">您希望AI记住的补充设定，例如回复的语气、对刀剑男士的私设、世界观等。</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">AI上下文记忆轮数</label>
                            <input type="number" class="form-input" id="aiContextRounds" placeholder="例如: 3" min="1">
                            <div class="prompt-note">控制生成回帖时AI能看到的历史对话。每轮为10条回帖，3轮即看最近30条。</div>
                        </div>
                        
                        <hr style="border: none; border-top: 1px solid #e0e0e0; margin: 30px 0;">

                        <div class="form-group">
                            <label class="form-label">交流板块保存页数</label>
                            <input type="number" class="form-input" id="chatPagesToKeep" placeholder="例如: 5" min="1">
                            <div class="prompt-note">保存最近的N页帖子列表。超出部分将在保存设置时自动清理。</div>
                        </div>
                
                        <div class="form-group">
                            <label class="form-label">匿名板块保存页数</label>
                            <input type="number" class="form-input" id="anonPagesToKeep" placeholder="例如: 5" min="1">
                            <div class="prompt-note">保存最近的N页帖子列表。超出部分将在保存设置时自动清理。</div>
                        </div>

                        <button class="save-btn" onclick="saveSettings()">保存设置</button>
                    </div>

                    <div class="settings-form" style="margin-top: 20px;">
                         <div class="form-group" style="margin-bottom: 5px;">
                             <label class="form-label">清除所有帖子数据</label>
                            <button class="save-btn clear-btn" onclick="clearAllForumData()">立即清除</button>
                            <div class="prompt-note">警告：此操作将删除所有本地存储的帖子和回复，且无法恢复。</div>
                        </div>
                    </div>
                </div>

                <!-- 我的页面 -->
                <div class="page" id="profilePage">
                    <div class="profile-form">
                        <div class="profile-title">个人信息</div>

                        <div class="form-group">
                            <label class="form-label">审神者名</label>
                            <input type="text" class="form-input" id="profileName" placeholder="请输入审神者名">
                        </div>

                        <div class="form-group">
                            <label class="form-label">属国</label>
                            <input type="text" class="form-input" id="profileCountry" placeholder="请输入属国">
                        </div>

                        <div class="form-group">
                            <label class="form-label">本丸名</label>
                            <input type="text" class="form-input" id="profileCitadel" placeholder="请输入本丸名">
                        </div>

                        <div class="form-group">
                            <label class="form-label">就任日</label>
                            <input type="date" class="form-input" id="profileDate">
                        </div>

                        <div class="form-group">
                            <label class="form-label">匿名ID后缀</label>
                            <input type="text" class="form-input" id="profileAnonId" placeholder="4-8位字母或数字" maxlength="8">
                             <div class="prompt-note">您在匿名板块发帖时，将显示为“匿名用户_您设置的后缀”。</div>
                        </div>

                        <button class="save-btn" onclick="saveProfile()">保存信息</button>
                    </div>
                </div>
            </div>

            <div class="bottom-nav">
                <div class="nav-item active" onclick="switchTab('discover')">
                    <div class="nav-text">发现</div>
                </div>
                <div class="nav-item" onclick="switchTab('profile')">
                    <div class="nav-text">我的</div>
                </div>
                <div class="nav-item" onclick="switchTab('settings')">
                    <div class="nav-text">设置</div>
                </div>
            </div>
        </div>
        
        <!-- 论坛列表页面 -->
        <div class="forum-container" id="forumContainer">
            <div class="forum-header">
                <div class="forum-logo-section">
                    <div class="forum-logo-title">时之论坛</div>
                    <div class="forum-logo-subtitle">The Forum of the Time</div>
                </div>
                <div class="forum-header-buttons">
                    <button class="forum-header-btn forum-refresh-btn" onclick="refreshPosts()">刷新</button>
                    <button class="forum-header-btn forum-post-btn" onclick="showPostModal()">发帖</button>
                    <button class="forum-header-btn forum-back-btn" onclick="goBackToMain()">返回</button>
                </div>
            </div>

            <div class="forum-content" id="forumPostList">
                <div class="forum-loading" id="forumLoading">正在加载...</div>
            </div>

            <div class="forum-pagination" id="forumPagination">
                <button class="forum-pagination-btn" id="forumPrevBtn" onclick="goToForumPage(forumCurrentPage - 1)">‹</button>
                <span class="forum-page-info" id="forumPageInfo">第 1 页 / 共 1 页</span>
                <button class="forum-pagination-btn" id="forumNextBtn" onclick="goToForumPage(forumCurrentPage + 1)">›</button>
            </div>
        </div>
        
        <!-- 帖子详情页面 -->
        <div class="detail-container" id="detailContainer">
            <div class="detail-header">
                <button class="detail-back-btn" onclick="goBackToForum()">返回</button>
                <div class="detail-title" id="detailTitle">帖子详情</div>
                <div style="width: 50px;"></div>
            </div>

            <div class="detail-content">
                <!-- 主帖 -->
                <div class="main-post" id="mainPost">
                    <div class="loading-animation">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">正在加载...</div>
                    </div>
                </div>

                <!-- 回复列表 -->
                <div id="repliesList">
                    <!-- 回复内容将在这里动态生成 -->
                </div>

                <!-- 加载更多按钮 -->
                <button class="load-more-btn" id="loadMoreBtn" onclick="loadMoreReplies()" style="display: none;">
                    加载更多回复
                </button>

                <!-- 回复输入区域 -->
                <div class="reply-input-section">
                    <div class="reply-input-title" id="replyInputTitle">发表回复</div>
                    <div id="quoteBlock" style="display: none;"></div>
                    <textarea class="reply-textarea" id="replyTextarea" placeholder="请输入您的回复内容..."></textarea>
                    <button class="reply-submit-btn" onclick="submitReply()">发表回复</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 发帖模态框 -->
    <div class="forum-modal" id="forumPostModal">
        <div class="forum-modal-content">
            <button class="forum-modal-close" onclick="closePostModal()">&times;</button>
            <div class="forum-modal-title">发表新帖</div>
            
            <div class="form-group">
                <label class="form-label">帖子类型</label>
                <select class="form-input" id="forumPostType">
                    <option value="闲聊">闲聊</option>
                    <option value="交流">交流</option>
                    <option value="灌水">灌水</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">帖子标题</label>
                <input type="text" class="form-input" id="forumPostTitle" placeholder="请输入帖子标题">
            </div>
            
            <div class="form-group">
                <label class="form-label">帖子内容</label>
                <textarea class="form-input form-textarea" id="forumPostContent" placeholder="请输入帖子内容..."></textarea>
            </div>
            
            <button class="forum-submit-btn" onclick="submitPost()">发表帖子</button>
        </div>
    </div>
    
    <!-- 登录模态框 -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeLoginModal()">&times;</button>
            <div class="modal-title">用户登录</div>
            
            <div class="form-group">
                <label class="form-label">昵称</label>
                <input type="text" class="form-input" id="nickname" placeholder="请输入昵称">
            </div>
            
            <div class="form-group">
                <label class="form-label">账号</label>
                <input type="text" class="form-input" id="username" placeholder="请输入账号">
            </div>
            
            <div class="form-group">
                <label class="form-label">密码</label>
                <input type="password" class="form-input" id="password" placeholder="请输入密码">
            </div>
            
            <button class="login-form-btn" onclick="performLogin()">登录</button>
        </div>
    </div>
    
    <!-- Toast 提示 -->
    <div class="toast" id="toast"></div>

<script>
    // 全局状态
    let currentUser = null;
    let userProfile = {
        name: '',
        country: '',
        citadel: '',
        joinDate: '',
        certified: false,
        anonId: '' 
    };
    let settings = {
        baseUrl: '',
        apiKey: '',
        modelName: '',
        temperature: '',
        prompt: '',
        supplementarySettings: '',
        aiContextRounds: 3,
        chatPagesToKeep: 5,
        anonPagesToKeep: 5
    };

    // 论坛页面状态
    let currentForumMode = 'chat'; // 'chat' 或 'anonymous'

    // 交流板块的帖子数据
    let forumCurrentPage = 1;
    let forumTotalPages = 1;
    let forumAllPosts = []; // 这是一个二维数组，每个子数组代表一页的帖子
    let forumPostsPerPage = 10;

    // 匿名板块的帖子数据
    let anonForumCurrentPage = 1;
    let anonForumTotalPages = 1;
    let anonForumAllPosts = [];


    // 帖子详情页面状态
    let currentPostId = null;
    let currentPost = null;
    let currentReplies = [];
    let replyFloor = 1;
    let currentQuote = null;

    // ----- 本地存储功能 -----

    let forumData = {
        chatPosts: [],
        anonPosts: [],
        replies: {}
    };

    function saveForumData() {
        forumData.chatPosts = forumAllPosts;
        forumData.anonPosts = anonForumAllPosts;
        localStorage.setItem('forum_data', JSON.stringify(forumData));
    }

    function loadForumData() {
        const savedData = localStorage.getItem('forum_data');
        if (savedData) {
            try {
                forumData = JSON.parse(savedData);
                forumAllPosts = forumData.chatPosts || [];
                anonForumAllPosts = forumData.anonPosts || [];
            } catch (e) {
                console.error("解析本地论坛数据失败:", e);
                localStorage.removeItem('forum_data');
            }
        }
    }

    function clearAllForumData() {
        if (confirm('警告：此操作将清除所有本地保存的帖子列表和回复数据，且无法恢复。您确定要继续吗？')) {
            forumAllPosts = [];
            anonForumAllPosts = [];
            forumData = {
                chatPosts: [],
                anonPosts: [],
                replies: {}
            };
            localStorage.removeItem('forum_data');
            forumCurrentPage = 1;
            forumTotalPages = 1;
            anonForumCurrentPage = 1;
            anonForumTotalPages = 1;
            showToast('所有帖子数据已成功清除！');
        }
    }

    function loadAndApplySettings() {
        const savedSettings = localStorage.getItem('forum_settings');
        if (savedSettings) {
            const loadedSettings = JSON.parse(savedSettings);
            settings = { ...settings, ...loadedSettings };
        }
        document.getElementById('baseUrl').value = settings.baseUrl || '';
        document.getElementById('apiKey').value = settings.apiKey || '';
        document.getElementById('modelName').value = settings.modelName || '';
        document.getElementById('temperature').value = settings.temperature || '';
        document.getElementById('prompt').value = settings.prompt || '';
        document.getElementById('supplementarySettings').value = settings.supplementarySettings || '';
        document.getElementById('aiContextRounds').value = settings.aiContextRounds || 3;
        document.getElementById('chatPagesToKeep').value = settings.chatPagesToKeep || 5;
        document.getElementById('anonPagesToKeep').value = settings.anonPagesToKeep || 5;
        updateApiUrlPreview();
    }

    function loadAndApplyProfile() {
        const savedProfile = localStorage.getItem('forum_user_profile');
        if (savedProfile) {
            const loadedProfile = JSON.parse(savedProfile);
            userProfile = { ...userProfile, ...loadedProfile }; 
        }
        loadProfile();
    }

    function checkLoginState() {
        const savedUser = localStorage.getItem('forum_current_user');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            updateLoginStatus();
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadAndApplySettings();
        loadAndApplyProfile();
        checkLoginState();
        loadForumData();
        document.getElementById('baseUrl').addEventListener('input', updateApiUrlPreview);
    });

    function updateApiUrlPreview() {
        const baseUrlInput = document.getElementById('baseUrl');
        const apiUrlPreview = document.getElementById('apiUrlPreview');
        if (baseUrlInput && apiUrlPreview) {
            const baseUrl = baseUrlInput.value.trim().replace(/\/$/, '');
            const finalUrl = baseUrl ? `${baseUrl}/chat/completions` : '.../chat/completions';
            apiUrlPreview.innerHTML = `API 调用地址预览: <strong>${finalUrl}</strong>`;
        }
    }

    function switchTab(tab) {
        if (tab === 'profile' && !currentUser) {
            showToast('您还没有登入账号', 'error');
            return;
        }

        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));

        const tabMap = {
            'discover': { nav: '.nav-item:first-child', page: '#discoverPage' },
            'profile': { nav: '.nav-item:nth-child(2)', page: '#profilePage' },
            'settings': { nav: '.nav-item:last-child', page: '#settingsPage' }
        };

        if (tabMap[tab]) {
            document.querySelector(tabMap[tab].nav).classList.add('active');
            document.getElementById(tabMap[tab].page.substring(1)).classList.add('active');
            if (tab === 'profile') loadProfile();
        }
    }

    document.getElementById('loginBtn').addEventListener('click', function() {
        if (currentUser) logout();
        else document.getElementById('loginModal').style.display = 'block';
    });

    function closeLoginModal() {
        document.getElementById('loginModal').style.display = 'none';
    }

    function performLogin() {
        const nickname = document.getElementById('nickname').value.trim();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value.trim();
        if (!nickname || !username || !password) {
            showToast('请填写完整信息', 'error');
            return;
        }
        currentUser = { nickname, username };
        localStorage.setItem('forum_current_user', JSON.stringify(currentUser));
        updateLoginStatus();
        closeLoginModal();
        showToast('登录成功！');
        document.getElementById('nickname').value = '';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
    }

    function logout() {
        currentUser = null;
        localStorage.removeItem('forum_current_user');
        updateLoginStatus();
        showToast('已退出登录');
    }

    function updateLoginStatus() {
        const welcomeText = document.getElementById('welcomeText');
        const subText = document.getElementById('subText');
        const loginBtn = document.getElementById('loginBtn');
        if (currentUser) {
            welcomeText.textContent = `${currentUser.nickname}，欢迎您！`;
            subText.textContent = '我们守护，我们抵御，我们捍卫。';
            loginBtn.textContent = '退出登录';
            loginBtn.style.background = '#CC726A';
        } else {
            welcomeText.textContent = '欢迎登录';
            subText.textContent = '登录后解锁阅览权限';
            loginBtn.textContent = '立即登录';
            loginBtn.style.background = '#88A936';
        }
    }

    function trimLocalData() {
        let trimmed = false;
        if (forumAllPosts.length > settings.chatPagesToKeep) {
            forumAllPosts.length = settings.chatPagesToKeep;
            trimmed = true;
        }
        if (anonForumAllPosts.length > settings.anonPagesToKeep) {
            anonForumAllPosts.length = settings.anonPagesToKeep;
            trimmed = true;
        }
        if (trimmed) {
            saveForumData();
            console.log('本地帖子数据已根据设置进行清理。');
            showToast('超出页数限制的旧帖子已自动清理');
        }
    }

    function saveSettings() {
        settings.baseUrl = document.getElementById('baseUrl').value.trim();
        settings.apiKey = document.getElementById('apiKey').value.trim();
        settings.modelName = document.getElementById('modelName').value.trim();
        settings.temperature = document.getElementById('temperature').value.trim();
        settings.prompt = document.getElementById('prompt').value.trim();
        settings.supplementarySettings = document.getElementById('supplementarySettings').value.trim();
        settings.aiContextRounds = parseInt(document.getElementById('aiContextRounds').value, 10) || 3;
        settings.chatPagesToKeep = parseInt(document.getElementById('chatPagesToKeep').value, 10) || 5;
        settings.anonPagesToKeep = parseInt(document.getElementById('anonPagesToKeep').value, 10) || 5;
        if (!settings.baseUrl || !settings.apiKey || !settings.modelName) {
            showToast('请填写完整的API配置信息', 'error');
            return;
        }
        localStorage.setItem('forum_settings', JSON.stringify(settings));
        trimLocalData();
        showToast('设置已保存！');
        console.log('AI配置已更新:', settings);
    }
    
    async function fetchModels() {
        const baseUrl = document.getElementById('baseUrl').value.trim();
        const apiKey = document.getElementById('apiKey').value.trim();
        const fetchBtn = document.getElementById('fetchModelsBtn');
        const modelDatalist = document.getElementById('modelList');
        if (!baseUrl || !apiKey) {
            showToast('请先填写 Base URL 和 API Key', 'error');
            return;
        }
        fetchBtn.disabled = true;
        fetchBtn.textContent = '拉取中...';
        modelDatalist.innerHTML = '';
        const endpoint = baseUrl.replace(/\/$/, '') + '/v1/models';
        try {
            const response = await fetch(endpoint, {
                headers: { 'Authorization': `Bearer ${apiKey}` }
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: response.statusText }));
                throw new Error(`API请求失败: ${errorData.error ? errorData.error.message : response.statusText}`);
            }
            const data = await response.json();
            if (data && data.data && Array.isArray(data.data)) {
                data.data.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    modelDatalist.appendChild(option);
                });
                showToast(`成功拉取 ${data.data.length} 个模型！`);
            } else {
                throw new Error('返回的模型数据格式不正确');
            }
        } catch (error) {
            console.error('拉取模型失败:', error);
            showToast(`拉取模型失败: ${error.message}`, 'error');
        } finally {
            fetchBtn.disabled = false;
            fetchBtn.textContent = '拉取';
        }
    }

    function checkAPISettings() {
        return settings.baseUrl && settings.apiKey && settings.modelName;
    }
    
    function saveProfile() {
        userProfile.name = document.getElementById('profileName').value.trim();
        userProfile.country = document.getElementById('profileCountry').value.trim();
        userProfile.citadel = document.getElementById('profileCitadel').value.trim();
        userProfile.joinDate = document.getElementById('profileDate').value;
        userProfile.anonId = document.getElementById('profileAnonId').value.trim();

        if (userProfile.name && userProfile.country && userProfile.citadel && userProfile.joinDate) {
            userProfile.certified = true;
            showToast('个人信息已保存！');
            updateProfileDisplay();
        } else {
            userProfile.certified = false;
            showToast('请填写完整的个人信息', 'error');
        }
        localStorage.setItem('forum_user_profile', JSON.stringify(userProfile));
    }

    function loadProfile() {
        document.getElementById('profileName').value = userProfile.name || '';
        document.getElementById('profileCountry').value = userProfile.country || '';
        document.getElementById('profileCitadel').value = userProfile.citadel || '';
        document.getElementById('profileDate').value = userProfile.joinDate || '';
        document.getElementById('profileAnonId').value = userProfile.anonId || '';
        updateProfileDisplay();
    }
    
    function updateProfileDisplay() {
        const nameLabel = document.getElementById('profileName').previousElementSibling;
        let badge = nameLabel.querySelector('.certified-badge');
        if (userProfile.certified && userProfile.name) {
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'certified-badge';
                badge.textContent = '已认证';
                nameLabel.appendChild(badge);
            }
        } else if (badge) {
            badge.remove();
        }
    }

    async function navigateToChat() {
        if (!currentUser) { showToast('您还没有登入账号', 'error'); return; }
        if (!checkAPISettings()) { showToast('请先完成API配置', 'error'); return; }
        currentForumMode = 'chat';
        await showForumList();
    }

    async function navigateToAnonymous() {
        if (!currentUser) { showToast('您还没有登入账号', 'error'); return; }
        if (!checkAPISettings()) { showToast('请先完成API配置', 'error'); return; }
        currentForumMode = 'anonymous';
        await showForumList();
    }
    
    function navigateToMessages() {
        if (!currentUser) { showToast('您还没有登入账号', 'error'); return; }
        showToast('功能尚未开启！');
    }

    async function showForumList() {
        document.getElementById('mainContainer').classList.remove('active');
        document.getElementById('forumContainer').classList.add('active');

        const isAnonymous = currentForumMode === 'anonymous';
        const posts = isAnonymous ? anonForumAllPosts : forumAllPosts;
        const currentPage = isAnonymous ? anonForumCurrentPage : forumCurrentPage;
        
        document.querySelector('.forum-logo-subtitle').textContent = isAnonymous ? 'Anonymous Section' : 'The Forum of the Time';

        if (posts.length === 0) {
            try {
                await generateInitialPosts();
            } catch (error) {
                goBackToMain();
                return;
            }
        }
        displayForumPosts(currentPage);
        updateForumPagination();
    }

    function goBackToMain() {
        document.getElementById('forumContainer').classList.remove('active');
        document.getElementById('mainContainer').classList.add('active');
    }

    async function generateInitialPosts() {
        const isAnonymous = currentForumMode === 'anonymous';
        const targetArray = isAnonymous ? anonForumAllPosts : forumAllPosts;
        if (targetArray.length > 0) return;
        
        const postList = document.getElementById('forumPostList');
        postList.innerHTML = '<div class="forum-loading" id="forumLoading">正在加载...</div>';

        try {
            const firstPagePosts = await generatePostsWithAI(forumPostsPerPage);
            targetArray.push(firstPagePosts);
            if (isAnonymous) { anonForumTotalPages = 1; anonForumCurrentPage = 1; } 
            else { forumTotalPages = 1; forumCurrentPage = 1; }
            saveForumData();
        } catch (error) {
            console.error('Initial post generation failed:', error);
            showToast('AI调用失败，无法加载', 'error');
            postList.innerHTML = '<div class="forum-loading">加载失败，请检查AI设置后重试</div>';
            throw error;
        }
    }
    
    function formatDateTime(date) {
        const year = date.getFullYear().toString().slice(-2);
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const hour = date.getHours().toString().padStart(2, '0');
        const minute = date.getMinutes().toString().padStart(2, '0');
        return `${year}/${month}/${day}-${hour}:${minute}`;
    }
    
    function displayForumPosts(page) {
        const postList = document.getElementById('forumPostList');
        const isAnonymous = currentForumMode === 'anonymous';
        const allPosts = isAnonymous ? anonForumAllPosts : forumAllPosts;
        
        let html = '';
        const postsToDisplay = allPosts[page - 1];
        
        if (postsToDisplay && postsToDisplay.length > 0) {
            postsToDisplay.forEach(post => {
                html += `
                    <div class="forum-post-card" onclick="viewPostDetail('${post.id}')">
                        <div class="forum-post-title">${post.title}</div>
                        <div class="forum-post-meta">
                            <div class="forum-post-meta-left">
                                <span>${post.type}</span>
                                <span>${post.author}</span>
                            </div>
                            <span class="forum-post-time">${post.time}</span>
                        </div>
                    </div>
                `;
            });
            postList.innerHTML = html;
        } else {
            postList.innerHTML = '<div class="forum-loading">暂无帖子</div>';
        }
    }

    async function refreshPosts() {
        showToast('正在刷新...');
        const postList = document.getElementById('forumPostList');
        const oldContent = postList.innerHTML;
        postList.innerHTML = '<div class="forum-loading">刷新中...</div>';

        try {
            const isAnonymous = currentForumMode === 'anonymous';
            const targetArray = isAnonymous ? anonForumAllPosts : forumAllPosts;
            const newPagePosts = await generatePostsWithAI(forumPostsPerPage);
            targetArray.unshift(newPagePosts); 
            if (isAnonymous) { anonForumTotalPages = targetArray.length; anonForumCurrentPage = 1;} 
            else { forumTotalPages = targetArray.length; forumCurrentPage = 1; }
            saveForumData();
            trimLocalData();
            const currentPage = isAnonymous ? anonForumCurrentPage : forumCurrentPage;
            displayForumPosts(currentPage);
            updateForumPagination();
            showToast('页面已刷新！');
        } catch(error) {
            console.error("Refresh failed:", error);
            showToast('刷新失败', 'error');
            postList.innerHTML = oldContent;
        }
    }

    function showPostModal() {
        document.getElementById('forumPostModal').style.display = 'block';
    }

    function closePostModal() {
        document.getElementById('forumPostModal').style.display = 'none';
    }

    async function submitPost() {
        const title = document.getElementById('forumPostTitle').value.trim();
        const content = document.getElementById('forumPostContent').value.trim();
        const type = document.getElementById('forumPostType').value;
        if (!title || !content) { showToast('请填写完整的帖子信息', 'error'); return; }

        const submitBtn = document.querySelector('.forum-submit-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = '正在发表...';
        
        const isAnonymous = currentForumMode === 'anonymous';
        let author;

        if (isAnonymous) {
            if (!userProfile.anonId) {
                showToast('请先在“我的”页面设置您的匿名ID后缀', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = '发表帖子';
                return;
            }
            author = `匿名用户_${userProfile.anonId}`;
        } else {
            author = currentUser.nickname;
        }

        try {
            const postTimestamp = Date.now();
            const userPost = { id: postTimestamp, type, title, content, author, time: formatDateTime(new Date(postTimestamp)) };
            const otherPosts = await generatePostsWithAI(forumPostsPerPage - 1);
            const newPage = [userPost, ...otherPosts];
            const targetArray = isAnonymous ? anonForumAllPosts : forumAllPosts;
            targetArray.unshift(newPage);
            if (isAnonymous) { anonForumTotalPages = targetArray.length; anonForumCurrentPage = 1;} 
            else { forumTotalPages = targetArray.length; forumCurrentPage = 1;}
            saveForumData();
            trimLocalData();
            closePostModal();
            showToast('帖子发表成功！');
            viewPostDetail(userPost.id);
        } catch (error) {
            showToast('AI调用失败，无法发表帖子', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = '发表帖子';
            document.getElementById('forumPostTitle').value = '';
            document.getElementById('forumPostContent').value = '';
        }
    }

    function goToForumPage(page) {
        const totalPages = currentForumMode === 'anonymous' ? anonForumTotalPages : forumTotalPages;
        if (page < 1 || page > totalPages) return;
        if (currentForumMode === 'anonymous') { anonForumCurrentPage = page; } 
        else { forumCurrentPage = page; }
        displayForumPosts(page);
        updateForumPagination();
    }

    function updateForumPagination() {
        const allPosts = currentForumMode === 'anonymous' ? anonForumAllPosts : forumAllPosts;
        const totalPages = allPosts.length;
        const currentPage = currentForumMode === 'anonymous' ? anonForumCurrentPage : forumCurrentPage;
        if (currentForumMode === 'anonymous') { anonForumTotalPages = totalPages; }
        else { forumTotalPages = totalPages; }
        const pageInfo = document.getElementById('forumPageInfo');
        const prevBtn = document.getElementById('forumPrevBtn');
        const nextBtn = document.getElementById('forumNextBtn');
        pageInfo.textContent = `第 ${totalPages === 0 ? 0 : currentPage} 页 / 共 ${totalPages} 页`;
        prevBtn.classList.toggle('disabled', currentPage <= 1);
        nextBtn.classList.toggle('disabled', currentPage >= totalPages);
    }

    function viewPostDetail(postId) {
        currentPostId = Number(postId);
        document.getElementById('forumContainer').classList.remove('active');
        document.getElementById('detailContainer').classList.add('active');

        currentReplies = []; replyFloor = 1; currentQuote = null;
        document.getElementById('quoteBlock').style.display = 'none';
        document.getElementById('replyInputTitle').textContent = '发表回复';
        document.getElementById('repliesList').innerHTML = '';
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        loadMoreBtn.style.display = 'none';
        loadMoreBtn.textContent = '加载更多回复';
        document.querySelector('.reply-input-section').style.display = 'block';

        const allPosts = currentForumMode === 'anonymous' ? anonForumAllPosts : forumAllPosts;
        currentPost = allPosts.flat().find(p => p.id === currentPostId);
        
        if (currentPost) {
            displayMainPost(currentPost);
            if (forumData.replies && forumData.replies[currentPostId]) {
                currentReplies = forumData.replies[currentPostId];
                replyFloor = currentReplies.length > 0 ? Math.max(...currentReplies.map(r => r.floor)) + 1 : 1;
                displayReplies(currentReplies, false);
                loadMoreBtn.style.display = 'block';
            } else {
                setTimeout(() => loadMoreReplies(10), 300);
            }
        } else {
            displayPostNotFound();
        }
    }
    
    function displayPostNotFound() {
        document.getElementById('detailTitle').textContent = '帖子不存在';
        document.getElementById('mainPost').innerHTML = `<div class="post-content" style="text-align: center; padding: 40px 0;">该帖子已被删除或不存在。</div>`;
        document.getElementById('repliesList').innerHTML = '';
        document.getElementById('loadMoreBtn').style.display = 'none';
        document.querySelector('.reply-input-section').style.display = 'none';
    }

    function goBackToForum() {
        document.getElementById('detailContainer').classList.remove('active');
        document.getElementById('forumContainer').classList.add('active');
        const currentPage = currentForumMode === 'anonymous' ? anonForumCurrentPage : forumCurrentPage;
        displayForumPosts(currentPage);
        updateForumPagination();
    }

    function displayMainPost(post) {
        document.getElementById('detailTitle').textContent = post.title;
        const opTag = `<span class="op-tag" style="font-size: 11px; padding: 2px 7px;">楼主</span>`;
        document.getElementById('mainPost').innerHTML = `
            <div class="post-author">${post.author} ${opTag}</div>
            <div class="post-content">${(post.content || '').replace(/\n/g, '<br>')}</div>
            <div class="post-footer">
                <span>${post.type}</span>
                <span>${post.time}</span>
            </div>
        `;
    }

    async function loadMoreReplies(count = 10) {
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const repliesList = document.getElementById('repliesList');
        const aiGeneratingDiv = document.createElement('div');
        aiGeneratingDiv.className = 'ai-generating';
        aiGeneratingDiv.innerHTML = `<div class="ai-icon"></div><div class="ai-text">Loading...</div>`;
        
        loadMoreBtn.style.display = 'none';
        (repliesList.innerHTML === '' ? document.getElementById('mainPost') : repliesList).insertAdjacentElement(
            repliesList.innerHTML === '' ? 'afterend' : 'beforeend', 
            aiGeneratingDiv
        );

        try {
            const baseTimestamp = currentReplies.length > 0 ? currentReplies[currentReplies.length - 1].id : currentPost.id;
            const newReplies = await generateRepliesWithAI(count, baseTimestamp);
            currentReplies.push(...newReplies);
            forumData.replies[currentPostId] = currentReplies;
            saveForumData();
            aiGeneratingDiv.remove();
            displayReplies(newReplies, true);
            loadMoreBtn.textContent = '加载更多回复';
            loadMoreBtn.style.display = newReplies.length > 0 ? 'block' : 'none';
        } catch (error) {
            aiGeneratingDiv.remove();
            showToast('加载回复失败', 'error');
            loadMoreBtn.textContent = '加载失败，点击重试';
            loadMoreBtn.style.display = 'block';
        }
    }

    function displayReplies(replies, append = false) {
        const repliesList = document.getElementById('repliesList');
        if (!append) repliesList.innerHTML = '';
        
        replies.forEach(reply => {
            const replyElement = document.createElement('div');
            replyElement.className = 'reply-card';
             // 如果是用户自己的回复，添加高亮样式
            if (reply.isUser) {
                replyElement.classList.add('user-reply');
            }

            let quoteHTML = '';
            if (reply.quote) {
                quoteHTML = `<div class="quote-block">
                    <div class="quote-author">引用 ${reply.quote.floor}楼 ${reply.quote.author}：</div>
                    <div class="quote-content">${reply.quote.content}</div>
                </div>`;
            }
            const isOp = currentPost && reply.author === currentPost.author;
            const authorTag = isOp ? `<span class="op-tag">楼主</span>` : '';
            
            const safeContent = reply.content.substring(0, 30).replace(/'/g, "\\'");
            const authorForReplyFunc = reply.author.replace(/'/g, "\\'");
            replyElement.innerHTML = `
                <div class="reply-header">
                    <div class="reply-author-info">
                        <span class="reply-author">${reply.author}${authorTag}</span>
                        <span class="reply-floor">${reply.floor}楼</span>
                    </div>
                    <div class="reply-actions">
                        <span class="reply-time">${reply.time}</span>
                        <button class="reply-btn" onclick="replyToFloor(${reply.floor}, '${authorForReplyFunc}', '${safeContent}...')">回复</button>
                    </div>
                </div>
                ${quoteHTML}
                <div class="reply-content">${reply.content.replace(/\n/g, '<br>')}</div>
            `;
            repliesList.appendChild(replyElement);
        });
    }
    
    function replyToFloor(floor, author, content) {
        currentQuote = { floor, author, content };
        const quoteBlock = document.getElementById('quoteBlock');
        quoteBlock.innerHTML = `<div class="quote-block">
            <div class="quote-author">引用 ${floor}楼 ${author}：</div>
            <div class="quote-content">${content}</div>
        </div>`;
        quoteBlock.style.display = 'block';
        document.getElementById('replyInputTitle').textContent = `回复 ${floor}楼`;
        document.getElementById('replyTextarea').scrollIntoView({ behavior: 'smooth' });
        document.getElementById('replyTextarea').focus();
    }

    function submitReply() {
        const textarea = document.getElementById('replyTextarea');
        const content = textarea.value.trim();
        if (!content) { showToast('请输入回复内容', 'error'); return; }

        const isAnonymous = currentForumMode === 'anonymous';
        let author;

        if (isAnonymous) {
            if (!userProfile.anonId) {
                showToast('请先在“我的”页面设置您的匿名ID后缀', 'error');
                return;
            }
            author = `匿名用户_${userProfile.anonId}`;
        } else {
            author = currentUser.nickname;
        }

        const replyTimestamp = Date.now();
        const userReply = {
            id: replyTimestamp,
            author: author,
            content: content,
            time: formatDateTime(new Date(replyTimestamp)),
            floor: replyFloor++,
            quote: currentQuote,
            isUser: true // 核心修改：标记为用户回复
        };
        
        currentReplies.push(userReply);
        forumData.replies[currentPostId] = currentReplies;
        saveForumData();
        
        displayReplies([userReply], true);
        textarea.value = '';
        document.getElementById('quoteBlock').style.display = 'none';
        document.getElementById('replyInputTitle').textContent = '发表回复';
        currentQuote = null;
        showToast('回复发表成功！');
    }

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.background = type === 'error' ? '#f44336' : '#333';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    window.onclick = function(event) {
        if (event.target === document.getElementById('loginModal')) closeLoginModal();
        if (event.target === document.getElementById('forumPostModal')) closePostModal();
    }
    
    // --- AI 调用核心功能 ---
    
    async function callAI(messages) {
        if (!settings.baseUrl || !settings.apiKey || !settings.modelName) {
            throw new Error('AI配置不完整');
        }
        const endpoint = settings.baseUrl.replace(/\/$/, '') + '/chat/completions';
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
            body: JSON.stringify({
                model: settings.modelName,
                messages: messages,
                temperature: parseFloat(settings.temperature) || 0.7,
            })
        });
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: response.statusText }));
            throw new Error(`API请求失败: ${errorData.error ? errorData.error.message : response.statusText}`);
        }
        const data = await response.json();
        return data.choices[0].message.content;
    }

    async function generatePostsWithAI(count) {
        const isAnonymous = currentForumMode === 'anonymous';
        const systemPrompt = `
你是一个专用于模拟《刀剑乱舞》世界观下论坛内容的AI。
## 你的任务
根据用户请求，生成一个主题帖列表。
## 核心规则
1.  **世界观**: 所有内容都发生在《刀剑乱舞》的世界中，论坛里包括审神者、刀剑男士、时政职员（比如狐之助）等，都可以自由发帖，发帖和回帖的比例为审神者：刀男：时政职员＝4：4：2。
2.  **论坛风格与ID规则**: 帖子和作者ID必须自然、生活化。ID生成规则取决于当前板块：
    *   **普通板块**: 作者ID应有创意，例如 "隔壁本丸的柠檬精", "肝刀肝到头秃", "kashuu_my_love"。其他审神者的刀男可以用"爱喝茶的老头""偶尔吓一下"这种ID，但是绝对不能用原名。
    *   **匿名板块**: 作者ID必须严格遵循 "匿名用户_XXXX" 的格式，其中XXXX是由AI生成的4位字母或数字乱码。例如："匿名用户_a3f9", "匿名用户_88b1"。
3.  **特殊ID规则 (最重要)**:
    *   只有当发帖者是 **用户自己** 的刀剑男士时，其ID才 **必须显示为原名**（例如“加州清光”、“山姥切国广”）。
    *   这条规则的触发，应与用户的“自设”内容相匹配。
    *   这条规则 **覆盖** 上述所有普通ID规则，即使用户的刀剑男士在匿名板块发帖，ID也显示为原名。
4.  **板块差异**:
    *   **当前板块**: ${isAnonymous ? '匿名板块 (内容可以更自由、大胆，允许吐槽或情感宣泄)' : '普通板块 (日常闲聊、攻略交流、心情分享等)'}
5.  **JSON输出**: 你的最终输出必须是一个严格的、不含任何额外解释文字的JSON数组。
## 个性化设定 (这些设定提供了论坛的整体氛围和你需要融入的额外背景信息)
*   **用户自设**: "${settings.prompt || '无'}" (此项仅影响 **用户自己** 的刀剑男士，当AI决定生成一个属于用户的刀剑男士帖子时，其言行需符合此设定，且ID必须为原名。此设定与其他审神者及其刀剑男士、时政职员的帖子没有影响！！！)
*   **补充设定**: "${settings.supplementarySettings || '无'}"`;
        const userPrompt = `请为【${isAnonymous ? '匿名板块' : '普通板块'}】生成 ${count} 个全新的论坛主题帖。请严格遵守ID生成规则，只有“用户自己”的刀剑男士才能使用原名ID。每个帖子都必须包含 "title", "content", "type" (类型必须是 '闲聊', '交流', '灌水' 中的一个), 和 "author" (虚拟作者昵称) 这四个字段。请直接返回JSON数组。`;
        const messages = [{ role: 'system', content: systemPrompt }, { role: 'user', content: userPrompt }];
        const aiResponse = await callAI(messages);
        const cleanedResponse = aiResponse.trim().replace(/^```json\n?/, '').replace(/\n?```$/, '');
        const parsedPosts = JSON.parse(cleanedResponse);
        if (!Array.isArray(parsedPosts)) throw new Error("AI返回的不是数组格式");
        let baseTimestamp = Date.now();
        return parsedPosts.map(post => {
            const postTime = baseTimestamp;
            baseTimestamp -= (Math.random() * 5 * 60 * 60 * 1000);
            return {
                id: postTime,
                author: post.author,
                time: formatDateTime(new Date(postTime)),
                title: post.title,
                content: post.content,
                type: post.type,
            };
        });
    }

    async function generateRepliesWithAI(count, baseTimestamp) {
        const isAnonymous = currentForumMode === 'anonymous';
        const contextRounds = settings.aiContextRounds || 3;
        const recentRepliesCount = contextRounds * 10;
        
        const userLastReply = currentReplies.slice().reverse().find(r => r.isUser);

        const existingRepliesSample = currentReplies.slice(-recentRepliesCount).map(r => {
            let replyText = `${r.floor}楼 ${r.author}: "${r.content}"`;
            if (r.quote) {
                replyText = `> (引用 ${r.quote.floor}楼 ${r.quote.author}) \n` + replyText;
            }
            if (userLastReply && r.id === userLastReply.id) {
                replyText += "  <-- [THIS IS THE REAL USER'S LATEST REPLY]";
            }
            return replyText;
        }).join('\n\n');
        
        let priorityInstruction = '';
        if (userLastReply) {
            priorityInstruction = `
    *   **High-Priority Task**: The context contains a reply marked "[THIS IS THE REAL USER'S LATEST REPLY]" at floor ${userLastReply.floor}. You **MUST** generate at least one new reply that directly quotes floor ${userLastReply.floor}. The 'quote' object for this reply must be \`{"floor": ${userLastReply.floor}}\`. This is your most important task for this request.`;
        }

        const systemPrompt = `
你是一个专用于模拟《刀剑乱舞》世界观下论坛内容的AI。
## 你的任务
根据主楼内容和已有的部分回复，生成一批新的、来自不同虚拟用户的论坛回复。你将扮演多个角色进行回复。
## 核心规则
1.  **多角色扮演**: 你将扮演多个不同的论坛用户（审神者、其他本丸的刀剑男士、时政职员如狐之助等）进行回复。发帖和回帖的比例为审神者：刀男：时政职员＝4：4：2不必为每条回复都创造一个新用户，可以让部分用户在这一批次中多次发言。楼主 (${currentPost.author}) 也应该保持活跃。
2.  **上下文关联**: 你的回复必须紧密围绕主楼帖子的主题，并能自然地回应【最近的回复】。
3.  **ID生成规则 (最重要，必须严格遵守)**:
    *   **普通用户**: 所有不属于“用户”的角色（包括其他审神者的刀剑男士），其ID **绝对不能使用刀剑原名**。
        *   在 **普通板块**: 使用创意网名，如 "neko_89", "吃瓜小能手"。其他审神者的刀男可以用"爱喝茶的老头""偶尔吓一下"这种ID，但是绝对不能用原名。
        *   在 **匿名板块**: ID必须 **严格** 遵循 **"匿名用户_XXXX"** 的格式。前缀必须是 **精确的四个汉字 "匿名用户"**，后面跟一个下划线和4位随机字母数字。例如："匿名用户_a3f9", "匿名用户_88b1"。**绝对不要** 使用 "匿名_user_" 或任何其他变体。
    *   **特殊情况: 用户的刀剑男士**:
        *   只有当回复者是 **用户自己** 的刀剑男士时，其ID才 **必须显示为原名**（例如：“山姥切国广”）。
        *   这种特殊情况的触发，应该与用户的“自设”内容相匹配。
        *   此规则 **覆盖** 上述所有ID规则。即使在匿名板块，用户的刀剑男士ID也 **必须是原名**。
4.  **板块风格**:
    *   **当前板块**: ${isAnonymous ? '匿名板块 (风格可以更大胆、直接、调侃、情绪化)' : '普通板块 (风格为日常交流、幽默、理性)'}
5.  **JSON输出与引用**: 
    *   你的最终输出必须是一个严格的、不含任何额外解释文字的JSON数组。
    *   每个回复对象必须包含 "author" 和 "content" 字段。
    *   在 ${count} 条回复中，请确保有 2-3 条使用了 "quote" 对象进行引用，其中必须有 "floor" 字段指向被引用的楼层号。例如 \`{"author": "...", "content": "非常同意！", "quote": {"floor": 12}}\`。
    *   **CRITICAL**: \`content\` 字段只能包含回复本身，绝不能包含'引用XX楼'或重复引用内容。${priorityInstruction}
## 个性化设定
*   **用户自设**: "${settings.prompt || '无'}" (此设定 **仅** 应用于“用户自己”的刀剑男士。当AI决定生成一个属于用户的刀剑男士的回复时，其言行需符合此设定，并且其ID **必须** 为刀剑原名。)
*   **补充设定**: "${settings.supplementarySettings || '无'}" (这是论坛的通用背景设定。)`;
        
        const userPrompt = `
这是当前帖子的讨论上下文：
---
[主题帖]
标题: ${currentPost.title}
楼主 (${currentPost.author}): ${currentPost.content}
---
[最近的回复 (共 ${currentReplies.slice(-recentRepliesCount).length} 条)]
${existingRepliesSample || '(还没有回复)'}
---
请你作为论坛模拟器，严格遵守你的系统设定（特别是关于【用户刀剑男士ID必须为原名，其他ID绝不能为原名】以及【High-Priority Task】的规则），为这个帖子生成 ${count} 条全新的、风格各异的回复。请直接返回JSON数组。`;

        const messages = [{ role: 'system', content: systemPrompt }, { role: 'user', content: userPrompt }];

        const aiResponse = await callAI(messages);
        const cleanedResponse = aiResponse.trim().replace(/^```json\n?/, '').replace(/\n?```$/, '');
        const parsedReplies = JSON.parse(cleanedResponse);

        if (!Array.isArray(parsedReplies)) throw new Error("AI返回的不是数组格式");

        const now = Date.now();
        let lastReplyTimestamp = baseTimestamp;

        const newlyGeneratedReplies = parsedReplies.map(reply => {
            const calculatedTimestamp = lastReplyTimestamp + (Math.random() * 19 + 1) * 60 * 1000;
            const newTimestamp = Math.min(calculatedTimestamp, now);
            lastReplyTimestamp = newTimestamp;
            return {
                id: newTimestamp,
                author: reply.author,
                content: reply.content,
                time: formatDateTime(new Date(newTimestamp)),
                floor: replyFloor++,
                quote: reply.quote || null 
            };
        });

        const allAvailableReplies = [...currentReplies, ...newlyGeneratedReplies];
        newlyGeneratedReplies.forEach(reply => {
            if (reply.quote && reply.quote.floor && typeof reply.quote.floor === 'number') {
                const quotedReply = allAvailableReplies.find(r => r.floor === reply.quote.floor);
                if (quotedReply) {
                    reply.quote = {
                        floor: quotedReply.floor,
                        author: quotedReply.author,
                        content: quotedReply.content.substring(0, 30) + '...'
                    };
                } else {
                    reply.quote = null; 
                }
            } else {
                reply.quote = null; 
            }
        });

        const didAiReplyToUser = newlyGeneratedReplies.some(r => r.quote && userLastReply && r.quote.floor === userLastReply.floor);
        if (didAiReplyToUser) {
            const userReplyInContext = currentReplies.find(r => r.id === userLastReply.id);
            if(userReplyInContext) {
                delete userReplyInContext.isUser;
            }
        }
        
        return newlyGeneratedReplies;
    }
</script>

<!-- Service Worker 注册脚本 (START) -->
<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          })
          .catch(error => {
            console.log('ServiceWorker registration failed: ', error);
          });
      });
    }
</script>
<!-- Service Worker 注册脚本 (END) -->

</body>
</html>
